<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vegas Roulette - Dynatrace Observatory</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dt-purple': '#6C2C9C',
                        'dt-blue': '#00A1C9',
                        'dt-cyan': '#00D4FF',
                        'dt-green': '#73BE28',
                        'dt-orange': '#FFA86B',
                        'dt-yellow': '#FFD23F',
                        'dt-dark': '#151515',
                        'dt-darker': '#0A0A0A',
                        'dt-gray': '#2D2D2D',
                        'dt-light-gray': '#4A4A4A'
                    }
                }
            }
        }
    </script>
    
    <!-- OpenTelemetry Browser Instrumentation -->
    <script src="/js/opentelemetry-browser.js"></script>
    
    <style>
        .roulette-bg {
            background: 
                radial-gradient(circle at 10% 20%, rgba(108, 44, 156, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(0, 212, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(115, 190, 40, 0.05) 0%, transparent 60%),
                linear-gradient(135deg, #0A0A0A 0%, #151515 100%);
            min-height: 100vh;
        }
        
        .roulette-wheel {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #1a1a1a 0deg 9.73deg,
                #c8102e 9.73deg 19.46deg,
                #1a1a1a 19.46deg 29.19deg,
                #000000 29.19deg 38.92deg,
                #c8102e 38.92deg 48.65deg,
                #1a1a1a 48.65deg 58.38deg,
                #000000 58.38deg 68.11deg,
                #c8102e 68.11deg 77.84deg,
                #1a1a1a 77.84deg 87.57deg,
                #000000 87.57deg 97.3deg,
                #c8102e 97.3deg 107.03deg,
                #1a1a1a 107.03deg 116.76deg,
                #000000 116.76deg 126.49deg,
                #c8102e 126.49deg 136.22deg,
                #1a1a1a 136.22deg 145.95deg,
                #000000 145.95deg 155.68deg,
                #c8102e 155.68deg 165.41deg,
                #1a1a1a 165.41deg 175.14deg,
                #000000 175.14deg 184.87deg,
                #c8102e 184.87deg 194.6deg,
                #1a1a1a 194.6deg 204.33deg,
                #000000 204.33deg 214.06deg,
                #c8102e 214.06deg 223.79deg,
                #1a1a1a 223.79deg 233.52deg,
                #000000 233.52deg 243.25deg,
                #c8102e 243.25deg 252.98deg,
                #1a1a1a 252.98deg 262.71deg,
                #000000 262.71deg 272.44deg,
                #c8102e 272.44deg 282.17deg,
                #1a1a1a 282.17deg 291.9deg,
                #000000 291.9deg 301.63deg,
                #c8102e 301.63deg 311.36deg,
                #1a1a1a 311.36deg 321.09deg,
                #000000 321.09deg 330.82deg,
                #c8102e 330.82deg 340.55deg,
                #1a1a1a 340.55deg 350.28deg,
                #00843d 350.28deg 360deg
            );
            position: relative;
            margin: 0 auto;
            border: 8px solid #8B4513;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.8), inset 0 0 20px rgba(0, 0, 0, 0.5);
            transition: transform 3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .roulette-wheel.spinning {
            animation: spin 3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(1080deg); }
        }
        
        .wheel-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid #FFD700;
            z-index: 10;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.5));
        }
        
        .number-cell {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }
        
        .number-cell:hover {
            transform: scale(1.1);
            border-color: #00D4FF;
            box-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        
        .number-cell.selected {
            background: #00D4FF;
            color: #000;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.8);
        }
        
        .number-red {
            background: #c8102e;
            color: white;
        }
        
        .number-black {
            background: #1a1a1a;
            color: white;
        }
        
        .number-green {
            background: #00843d;
            color: white;
        }
        
        /* Responsive header styles */
        .responsive-header {
            height: clamp(60px, 8vh, 80px);
            flex-shrink: 0;
        }
        
        /* Side panel styles */
        .side-panel {
            background: linear-gradient(180deg, #1a1a1a 0%, #0a0a0a 100%);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.8);
        }
        
        .side-panel-open {
            transform: translateX(0) !important;
        }
        
        .config-toggle-btn {
            background: linear-gradient(135deg, #6C2C9C 0%, #00D4FF 100%);
            border: 2px solid rgba(0, 212, 255, 0.3);
        }
        
        .config-toggle-btn:hover {
            background: linear-gradient(135deg, #7d3dad 0%, #1ae5ff 100%);
            transform: scale(1.05);
        }
        
        .main-content-shifted {
            margin-left: 320px;
            transition: margin-left 0.3s ease-in-out;
        }
    </style>
</head>
<body class="roulette-bg text-white min-h-screen">
    <!-- Header -->
    <header class="responsive-header bg-dt-dark/90 backdrop-blur-md border-b border-dt-cyan/20 flex-shrink-0">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4 ml-16">
                    <button onclick="window.location.href='lobby.html'" class="bg-dt-gray hover:bg-dt-light-gray text-white px-4 py-2 rounded-lg font-semibold text-sm">
                        ‚Üê Lobby
                    </button>
                    <div>
                        <h1 class="text-xl font-bold text-dt-cyan">üé° Vegas Roulette</h1>
                        <p class="text-xs text-dt-light-gray">Dynatrace Observatory</p>
                    </div>
                </div>
                
                <!-- User info and balance -->
                <div class="flex items-center space-x-4">
                    <div class="bg-dt-dark/60 border border-dt-cyan/20 rounded-lg px-4 py-2">
                        <div class="flex items-center space-x-4 text-sm">
                            <div class="flex items-center space-x-2">
                                <div class="w-2 h-2 bg-dt-green rounded-full animate-pulse"></div>
                                <span class="text-dt-cyan">Agent:</span>
                                <span id="agentName" class="font-mono text-white">Loading...</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-dt-cyan">Balance:</span>
                                <span id="balanceDisplay" class="font-mono text-dt-yellow font-semibold">$0</span>
                            </div>
                            <button onclick="addFunds()" class="bg-dt-green hover:bg-dt-green/80 text-white px-3 py-1 rounded text-xs font-semibold transition-colors">
                                Deposit
                            </button>
                    </div>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Collapsible Side Panel for Cheat Configuration -->
    <div id="cheatSidePanel" class="fixed left-0 top-0 h-full w-80 max-w-[25vw] side-panel transform -translate-x-full transition-transform duration-300 ease-in-out z-40">
        <div class="p-6 h-full overflow-y-auto">
            <!-- Panel Header -->
            <div class="flex items-center justify-between mb-6 pb-4 border-b border-dt-light-gray/20">
                <div class="flex items-center space-x-3">
                    <div class="w-3 h-3 bg-dt-purple rounded-full animate-pulse"></div>
                    <h3 class="text-lg font-bold text-dt-cyan">‚öôÔ∏è Configuration Lab</h3>
                </div>
                <button id="closeSidePanel" onclick="toggleCheatSidePanel()" class="text-dt-light-gray hover:text-white transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <!-- Configuration Content -->
            <div class="space-y-6">
                <!-- Demo Methods Section -->
                <div class="bg-dt-darker/60 rounded-lg p-4 border border-dt-purple/30">
                    <div class="text-center mb-4">
                        <h4 class="text-dt-purple font-bold text-md mb-1">Demo Enhancement Methods</h4>
                        <div class="text-xs text-gray-400">Laboratory environment - All methods unlocked</div>
                        <div class="text-xs text-dt-green mt-1 bg-green-900/30 px-2 py-1 rounded">‚úì Free Testing Mode</div>
                    </div>
                    
                    <div class="space-y-3">
                        <button id="cheatBallControl" class="w-full cheat-button bg-green-900/30 hover:bg-green-800/50 border border-green-500/50 text-green-300 px-4 py-3 rounded-lg text-sm font-semibold transition-all text-left" onclick="activateCheat('ballControl')">
                            <div class="flex items-center justify-between mb-1">
                                <span class="flex items-center space-x-2">
                                    <span>üéØ</span>
                                    <span>Ball Control</span>
                                </span>
                                <span class="text-xs text-green-400 bg-green-900/50 px-2 py-1 rounded">FREE</span>
                            </div>
                            <div class="text-xs text-green-400/70 ml-6">Control ball trajectory and landing position (+30% win rate)</div>
                        </button>
                        
                        <button id="cheatWheelBias" class="w-full cheat-button bg-green-900/30 hover:bg-green-800/50 border border-green-500/50 text-green-300 px-4 py-3 rounded-lg text-sm font-semibold transition-all text-left" onclick="activateCheat('wheelBias')">
                            <div class="flex items-center justify-between mb-1">
                                <span class="flex items-center space-x-2">
                                    <span>‚öôÔ∏è</span>
                                    <span>Wheel Bias</span>
                                </span>
                                <span class="text-xs text-green-400 bg-green-900/50 px-2 py-1 rounded">FREE</span>
                            </div>
                            <div class="text-xs text-green-400/70 ml-6">Exploit wheel imperfections and bias patterns (+25% win rate)</div>
                        </button>
                        
                        <button id="cheatMagneticField" class="w-full cheat-button bg-green-900/30 hover:bg-green-800/50 border border-green-500/50 text-green-300 px-4 py-3 rounded-lg text-sm font-semibold transition-all text-left" onclick="activateCheat('magneticField')">
                            <div class="flex items-center justify-between mb-1">
                                <span class="flex items-center space-x-2">
                                    <span>üß≤</span>
                                    <span>Magnetic Field</span>
                                </span>
                                <span class="text-xs text-green-400 bg-green-900/50 px-2 py-1 rounded">FREE</span>
                            </div>
                            <div class="text-xs text-green-400/70 ml-6">Use magnetic fields to influence ball movement (+40% win rate)</div>
                        </button>
                        
                        <button id="cheatSectorPrediction" class="w-full cheat-button bg-green-900/30 hover:bg-green-800/50 border border-green-500/50 text-green-300 px-4 py-3 rounded-lg text-sm font-semibold transition-all text-left" onclick="activateCheat('sectorPrediction')">
                            <div class="flex items-center justify-between mb-1">
                                <span class="flex items-center space-x-2">
                                    <span>üìä</span>
                                    <span>Sector Prediction</span>
                                </span>
                                <span class="text-xs text-green-400 bg-green-900/50 px-2 py-1 rounded">FREE</span>
                            </div>
                            <div class="text-xs text-green-400/70 ml-6">Predict ball landing sector using physics analysis (+35% win rate)</div>
                        </button>
                        
                        <button onclick="deactivateCheat()" class="w-full bg-red-800/60 hover:bg-red-700/70 border border-red-500/50 text-white text-sm py-3 px-4 rounded-lg transition-all font-semibold">
                            üõë Reset to Baseline Configuration
                        </button>
                    </div>
                    
                    <div id="cheatStatus" class="text-center text-xs text-gray-400 mt-4 pt-4 border-t border-gray-700/50">
                        üî¨ Observatory Mode - Baseline Configuration Active
                    </div>
                </div>
                
                <!-- Status Information -->
                <div class="bg-dt-darker/40 rounded-lg p-4 border border-dt-cyan/20">
                    <h4 class="text-dt-cyan font-semibold text-sm mb-2">üìä Current Session Status</h4>
                    <div class="space-y-2 text-xs">
                        <div class="flex justify-between">
                            <span class="text-dt-light-gray">Enhancement Active:</span>
                            <span id="sidePanelCheatStatus" class="text-dt-yellow">None</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-dt-light-gray">Performance Boost:</span>
                            <span id="sidePanelBoostLevel" class="text-dt-green">Baseline</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-dt-light-gray">Demo Duration:</span>
                            <span class="text-dt-cyan">30 seconds</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Side Panel Toggle Button -->
    <button id="cheatToggleBtn" onclick="toggleCheatSidePanel()" class="fixed left-4 top-20 config-toggle-btn text-white p-3 rounded-lg shadow-lg transition-all duration-300 z-30">
        <div class="flex flex-col items-center space-y-1">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
            </svg>
            <div class="text-xs font-semibold">Enable Cheats</div>
        </div>
    </button>
    
    <!-- Main Game Area -->
    <main class="container mx-auto px-4 py-8">
        <div class="grid lg:grid-cols-3 gap-6">
            <!-- Roulette Wheel -->
            <div class="lg:col-span-1">
                <div class="bg-dt-gray/50 backdrop-blur-sm rounded-xl p-6 border border-dt-purple/30">
                    <h2 class="text-xl font-bold text-center mb-6 text-dt-cyan">Roulette Wheel</h2>
                    <div class="flex justify-center mb-6">
                            <div class="relative">
                            <div id="rouletteWheel" class="roulette-wheel">
                                    <div class="wheel-pointer"></div>
                            </div>
                        </div>
                    </div>
                    <div id="resultDisplay" class="text-center p-4 bg-dt-darker rounded-lg border border-dt-purple/30">
                        <div id="winningNumber" class="text-4xl font-bold mb-2">?</div>
                        <div id="winningColor" class="text-lg"></div>
                        <div id="winMessage" class="mt-2"></div>
                        </div>
                    </div>
                </div>
                
            <!-- Betting Matrix -->
            <div class="lg:col-span-1">
                <div class="bg-dt-gray/50 backdrop-blur-sm rounded-xl p-6 border border-dt-purple/30">
                    <h2 class="text-xl font-bold text-center mb-6 text-dt-cyan">Betting Matrix</h2>
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <!-- Numbers 0-36 -->
                        <div id="number-0" class="number-cell number-green" onclick="selectNumber(0)">0</div>
                        <!-- Red numbers -->
                        <div id="number-1" class="number-cell number-red" onclick="selectNumber(1)">1</div>
                        <div id="number-2" class="number-cell number-black" onclick="selectNumber(2)">2</div>
                        <div id="number-3" class="number-cell number-red" onclick="selectNumber(3)">3</div>
                        <div id="number-4" class="number-cell number-black" onclick="selectNumber(4)">4</div>
                        <div id="number-5" class="number-cell number-red" onclick="selectNumber(5)">5</div>
                        <div id="number-6" class="number-cell number-black" onclick="selectNumber(6)">6</div>
                        <div id="number-7" class="number-cell number-red" onclick="selectNumber(7)">7</div>
                        <div id="number-8" class="number-cell number-black" onclick="selectNumber(8)">8</div>
                        <div id="number-9" class="number-cell number-red" onclick="selectNumber(9)">9</div>
                        <div id="number-10" class="number-cell number-black" onclick="selectNumber(10)">10</div>
                        <div id="number-11" class="number-cell number-black" onclick="selectNumber(11)">11</div>
                        <div id="number-12" class="number-cell number-red" onclick="selectNumber(12)">12</div>
                        <div id="number-13" class="number-cell number-black" onclick="selectNumber(13)">13</div>
                        <div id="number-14" class="number-cell number-red" onclick="selectNumber(14)">14</div>
                        <div id="number-15" class="number-cell number-black" onclick="selectNumber(15)">15</div>
                        <div id="number-16" class="number-cell number-red" onclick="selectNumber(16)">16</div>
                        <div id="number-17" class="number-cell number-black" onclick="selectNumber(17)">17</div>
                        <div id="number-18" class="number-cell number-red" onclick="selectNumber(18)">18</div>
                        <div id="number-19" class="number-cell number-red" onclick="selectNumber(19)">19</div>
                        <div id="number-20" class="number-cell number-black" onclick="selectNumber(20)">20</div>
                        <div id="number-21" class="number-cell number-red" onclick="selectNumber(21)">21</div>
                        <div id="number-22" class="number-cell number-black" onclick="selectNumber(22)">22</div>
                        <div id="number-23" class="number-cell number-red" onclick="selectNumber(23)">23</div>
                        <div id="number-24" class="number-cell number-black" onclick="selectNumber(24)">24</div>
                        <div id="number-25" class="number-cell number-red" onclick="selectNumber(25)">25</div>
                        <div id="number-26" class="number-cell number-black" onclick="selectNumber(26)">26</div>
                        <div id="number-27" class="number-cell number-red" onclick="selectNumber(27)">27</div>
                        <div id="number-28" class="number-cell number-black" onclick="selectNumber(28)">28</div>
                        <div id="number-29" class="number-cell number-black" onclick="selectNumber(29)">29</div>
                        <div id="number-30" class="number-cell number-red" onclick="selectNumber(30)">30</div>
                        <div id="number-31" class="number-cell number-black" onclick="selectNumber(31)">31</div>
                        <div id="number-32" class="number-cell number-red" onclick="selectNumber(32)">32</div>
                        <div id="number-33" class="number-cell number-black" onclick="selectNumber(33)">33</div>
                        <div id="number-34" class="number-cell number-red" onclick="selectNumber(34)">34</div>
                        <div id="number-35" class="number-cell number-black" onclick="selectNumber(35)">35</div>
                        <div id="number-36" class="number-cell number-red" onclick="selectNumber(36)">36</div>
                        </div>
                    
                    <!-- Quick Bet Options -->
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button onclick="selectBetType('red')" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition-colors">Red</button>
                        <button onclick="selectBetType('black')" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors">Black</button>
                        <button onclick="selectBetType('even')" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors">Even</button>
                        <button onclick="selectBetType('odd')" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition-colors">Odd</button>
                        <button onclick="selectBetType('low')" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition-colors">Low (1-18)</button>
                        <button onclick="selectBetType('high')" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded-lg transition-colors">High (19-36)</button>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="lg:col-span-1">
                <div class="bg-dt-gray/50 backdrop-blur-sm rounded-xl p-6 border border-dt-purple/30">
                    <h2 class="text-xl font-bold text-center mb-6 text-dt-cyan">Betting Controls</h2>
                    
                    <div class="mb-4">
                        <label class="block text-sm mb-2">Bet Amount:</label>
                        <input type="number" id="betAmount" value="10" min="10" max="1000" class="w-full px-4 py-2 bg-dt-darker border border-dt-purple/30 rounded-lg text-white">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm mb-2">Bet Type:</label>
                        <select id="betType" class="w-full px-4 py-2 bg-dt-darker border border-dt-purple/30 rounded-lg text-white">
                            <option value="red">Red</option>
                            <option value="black">Black</option>
                            <option value="even">Even</option>
                            <option value="odd">Odd</option>
                            <option value="low">Low (1-18)</option>
                            <option value="high">High (19-36)</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <div class="text-sm text-gray-400 mb-2">Selected Number:</div>
                        <div id="selectedNumber" class="text-lg font-bold text-dt-cyan">None</div>
                </div>

                    <button id="spinBtn" onclick="spinRoulette()" class="w-full px-6 py-3 bg-gradient-to-r from-dt-purple to-dt-cyan hover:from-dt-purple/80 hover:to-dt-cyan/80 rounded-lg font-bold text-lg transition-all transform hover:scale-105">
                        üé° SPIN
                    </button>
                    
                    <div id="gameResult" class="mt-4 p-4 bg-dt-darker rounded-lg border border-dt-purple/30 hidden">
                        <div id="resultText" class="text-center"></div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentBalance = 1000; // Will be synced from server/localStorage
        let selectedNumber = null;
        let selectedBetType = 'red';
        let cheatActive = false;
        let cheatType = 'ballControl';
        let cheatsEnabled = false;
        const redNumbers = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];
        
        // Deprecated: checkCheatFeatureFlag removed
        // Cheat controls are always visible in the UI
        // Feature flags are now handled by backend services via OpenFeature
        
        function toggleCheat() {
            const toggle = document.getElementById('cheatToggle');
            cheatActive = toggle.checked;
            const cheatTypeContainer = document.getElementById('cheatTypeContainer');
            if (cheatActive) {
                cheatTypeContainer.classList.remove('hidden');
                cheatType = document.getElementById('cheatType').value;
            } else {
                cheatTypeContainer.classList.add('hidden');
            }
        }
        
        // Get username from localStorage or use default
        const currentUser = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous';
        
        // Update balance display function
        function updateBalanceDisplay() {
            const balance = localStorage.getItem('vegasBalance') || '1000';
            const balanceElement = document.getElementById('balanceDisplay');
            if (balanceElement) {
                balanceElement.textContent = `$${parseInt(balance)}`;
            }
            // Also update the internal currentBalance variable
            currentBalance = parseFloat(balance);
        }
        
        // Sync balance with server on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Set agent name
            const username = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Agent';
            const agentNameElement = document.getElementById('agentName');
            if (agentNameElement) {
                agentNameElement.textContent = username;
            }
            
            // Sync balance with server
            try {
                const resp = await fetch('/api/user/init', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ Username: username })
                });
                const u = await resp.json();
                if (typeof u.balance === 'number') {
                    localStorage.setItem('vegasBalance', String(u.balance));
                    updateBalanceDisplay();
                } else {
                    updateBalanceDisplay();
                }
            } catch (e) {
                console.warn('Could not sync balance with server, using local storage:', e);
                updateBalanceDisplay();
            }
            
            // Initialize cheat UI (cheat controls are always visible)
            updateCheatUI();
            updateSidePanelStatus();

            // Ensure that changing the bet type via the dropdown also clears any previously selected number.
            // This prevents unintended combined bets (number + color/type) when the user only wants a simple bet.
            const betTypeSelect = document.getElementById('betType');
            if (betTypeSelect) {
                betTypeSelect.addEventListener('change', (e) => {
                    const newType = e.target.value;
                    selectBetType(newType);
                });
            }
        });
        
        async function addFunds() {
            const username = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous';
            const traceId = 'deposit-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            try {
                const resp = await fetch('/api/user/topup', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Trace-Id': traceId,
                        'X-User-Action': 'deposit'
                    },
                    body: JSON.stringify({ 
                        Username: username, 
                        Amount: 500,
                        TraceId: traceId
                    })
                });
                
                if (resp.ok) {
                    const data = await resp.json();
                    if (typeof data.balance === 'number') {
                        localStorage.setItem('vegasBalance', String(data.balance));
                        updateBalanceDisplay();
                        console.log(`üí∞ Deposited $500! New balance: $${data.balance}`);
                    } else {
                        // Fallback: add to current balance
                        const currentBalance = parseFloat(localStorage.getItem('vegasBalance') || '1000');
                        const newBalance = currentBalance + 500;
                        localStorage.setItem('vegasBalance', String(newBalance));
                        updateBalanceDisplay();
                        console.log(`üí∞ Deposited $500! New balance: $${newBalance}`);
                    }
                } else {
                    throw new Error(`Deposit failed: ${resp.status}`);
                }
            } catch (error) {
                console.error('Error depositing funds:', error);
                // Fallback: add to current balance locally
                const currentBalance = parseFloat(localStorage.getItem('vegasBalance') || '1000');
                const newBalance = currentBalance + 500;
                localStorage.setItem('vegasBalance', String(newBalance));
                updateBalanceDisplay();
                console.log(`üí∞ Deposited $500 (local)! New balance: $${newBalance}`);
            }
        }
        
        function selectNumber(num) {
            selectedNumber = num;
            // Update UI
            document.querySelectorAll('.number-cell').forEach(cell => {
                cell.classList.remove('selected');
            });
            if (num !== null) {
                const cell = document.getElementById(`number-${num}`);
                if (cell) {
                    cell.classList.add('selected');
                }
            }
            document.getElementById('selectedNumber').textContent = num !== null ? num : 'None';
        }
        
        function selectBetType(type) {
            selectedBetType = type;
            document.getElementById('betType').value = type;
            selectedNumber = null;
            document.querySelectorAll('.number-cell').forEach(cell => {
                cell.classList.remove('selected');
            });
            document.getElementById('selectedNumber').textContent = 'None';
        }
        
        // Roulette-specific cheat methods
        const cheatMethods = {
            ballControl: {
                name: 'Ball Control',
                winBoost: 30,
                description: 'Control ball trajectory and landing position'
            },
            wheelBias: {
                name: 'Wheel Bias',
                winBoost: 25,
                description: 'Exploit wheel imperfections and bias patterns'
            },
            magneticField: {
                name: 'Magnetic Field',
                winBoost: 40,
                description: 'Use magnetic fields to influence ball movement'
            },
            sectorPrediction: {
                name: 'Sector Prediction',
                winBoost: 35,
                description: 'Predict ball landing sector using physics analysis'
            }
        };
        
        // Cheat state management
        let cheatState = {
            active: null,
            winRateBoost: 0
        };
        
        // Side panel toggle for cheat controls
        let sidePanelOpen = false;
        
        function toggleCheatSidePanel() {
            const sidePanel = document.getElementById('cheatSidePanel');
            const toggleBtn = document.getElementById('cheatToggleBtn');
            
            if (!sidePanel) return;
            
            sidePanelOpen = !sidePanelOpen;
            
            if (sidePanelOpen) {
                // Show side panel
                sidePanel.classList.remove('-translate-x-full');
                sidePanel.classList.add('translate-x-0');
                if (toggleBtn) toggleBtn.style.left = '324px'; // 320px panel width + 4px margin
                console.log('üéØ Configuration Lab opened');
            } else {
                // Hide side panel
                sidePanel.classList.remove('translate-x-0');
                sidePanel.classList.add('-translate-x-full');
                if (toggleBtn) toggleBtn.style.left = '16px'; // Reset to original position
                console.log('üéØ Configuration Lab closed');
            }
        }
        
        // Cheat activation functions
        function activateCheat(cheatTypeParam) {
            const cheat = cheatMethods[cheatTypeParam];
            if (!cheat) {
                console.warn(`Unknown cheat type: ${cheatTypeParam}`);
                return;
            }
            
            cheatState.active = cheatTypeParam;
            cheatState.winRateBoost = cheat.winBoost;
            cheatType = cheatTypeParam; // Update global cheatType variable
            cheatActive = true; // Update global cheatActive for backward compatibility
            
            updateCheatUI();
            updateSidePanelStatus();
            console.log(`üöÄ ${cheat.name} activated! Win boost: +${cheat.winBoost}%`);
        }
        
        function deactivateCheat() {
            if (!cheatState.active) return;
            
            cheatState.active = null;
            cheatState.winRateBoost = 0;
            cheatType = 'ballControl'; // Reset to default
            cheatActive = false; // Update global cheatActive for backward compatibility
            
            updateCheatUI();
            updateSidePanelStatus();
            console.log('üîÑ Configuration reset to baseline');
        }
        
        function updateCheatUI() {
            const buttons = ['cheatBallControl', 'cheatWheelBias', 'cheatMagneticField', 'cheatSectorPrediction'];
            const types = ['ballControl', 'wheelBias', 'magneticField', 'sectorPrediction'];
            
            buttons.forEach((buttonId, index) => {
                const button = document.getElementById(buttonId);
                if (!button) return;
                
                const cheatType = types[index];
                const cheat = cheatMethods[cheatType];
                
                if (cheatState.active === cheatType) {
                    button.classList.add('bg-red-600', 'animate-pulse');
                    button.classList.remove('bg-green-900/30');
                    button.innerHTML = `
                        <div class="flex items-center justify-between mb-1">
                            <span class="flex items-center space-x-2">
                                <span>üî•</span>
                                <span>${cheat.name}</span>
                            </span>
                            <span class="text-xs text-red-400 bg-red-900/50 px-2 py-1 rounded">ACTIVE</span>
                        </div>
                        <div class="text-xs text-red-400/70 ml-6">${cheat.name} Running</div>
                    `;
                } else {
                    button.classList.remove('bg-red-600', 'animate-pulse');
                    button.classList.add('bg-green-900/30');
                    const icons = ['üéØ', '‚öôÔ∏è', 'üß≤', 'üìä'];
                    button.innerHTML = `
                        <div class="flex items-center justify-between mb-1">
                            <span class="flex items-center space-x-2">
                                <span>${icons[index]}</span>
                                <span>${cheat.name}</span>
                            </span>
                            <span class="text-xs text-green-400 bg-green-900/50 px-2 py-1 rounded">FREE</span>
                        </div>
                        <div class="text-xs text-green-400/70 ml-6">${cheat.description} (+${cheat.winBoost}% win rate)</div>
                    `;
                }
            });
        }
        
        function updateSidePanelStatus() {
            // Update main status message
            const statusEl = document.getElementById('cheatStatus');
            if (statusEl) {
                if (cheatState.active) {
                    const activeCheat = cheatMethods[cheatState.active];
                    statusEl.innerHTML = `üî• ${activeCheat.name} Active - +${activeCheat.winBoost}% Win Rate`;
                    statusEl.className = 'text-center text-xs text-red-300 mt-4 pt-4 border-t border-gray-700/50';
                } else {
                    statusEl.innerHTML = 'üî¨ Observatory Mode - Baseline Configuration Active';
                    statusEl.className = 'text-center text-xs text-gray-400 mt-4 pt-4 border-t border-gray-700/50';
                }
            }
            
            // Update side panel status elements
            const sidePanelCheatStatus = document.getElementById('sidePanelCheatStatus');
            const sidePanelBoostLevel = document.getElementById('sidePanelBoostLevel');
            
            if (sidePanelCheatStatus) {
                if (cheatState.active) {
                    const activeCheat = cheatMethods[cheatState.active];
                    sidePanelCheatStatus.textContent = activeCheat.name;
                    sidePanelCheatStatus.className = 'text-dt-green font-semibold';
                } else {
                    sidePanelCheatStatus.textContent = 'None';
                    sidePanelCheatStatus.className = 'text-dt-yellow';
                }
            }
            
            if (sidePanelBoostLevel) {
                if (cheatState.active) {
                    sidePanelBoostLevel.textContent = `+${cheatState.winRateBoost}%`;
                    sidePanelBoostLevel.className = 'text-dt-green font-semibold';
                } else {
                    sidePanelBoostLevel.textContent = 'Baseline';
                    sidePanelBoostLevel.className = 'text-dt-cyan';
                }
            }
        }
        
        async function spinRoulette() {
            const betAmount = parseFloat(document.getElementById('betAmount').value);
            const betType = document.getElementById('betType').value;
            const username = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous';
            
            // Get current balance from localStorage (synced with server)
            const currentBalance = parseFloat(localStorage.getItem('vegasBalance') || '1000');
            
            if (betAmount > currentBalance) {
                alert('Insufficient balance!');
                return;
            }
            
            if (betAmount < 10) {
                alert('Minimum bet is $10!');
                return;
            }
            
            // Disable spin button
            const spinBtn = document.getElementById('spinBtn');
            spinBtn.disabled = true;
            spinBtn.textContent = 'SPINNING...';
            
            // Add spinning animation
            const wheel = document.getElementById('rouletteWheel');
            wheel.classList.add('spinning');
            
            // Prepare request - roulette service expects specific format
            let requestBody;
            
            // Check if both a number and a bet type are selected
            const hasNumberBet = selectedNumber !== null;
            const hasColorBet = betType && betType !== 'none' && ['red', 'black', 'even', 'odd', 'low', 'high'].includes(betType);
            
            if (hasNumberBet && hasColorBet) {
                // Multiple bets: both number and color/type bet
                // Each bet is independent, so total bet is sum of both
                const totalBetAmount = betAmount * 2;
                requestBody = {
                    Username: username,
                    BetAmount: totalBetAmount, // Total bet amount for balance deduction
                    BetType: 'multiple',
                    BetValue: {
                        [`bet_${selectedNumber}`]: {
                            type: 'straight',
                            value: selectedNumber.toString(),
                            amount: betAmount
                        },
                        [`bet_${betType}`]: {
                            type: betType,
                            amount: betAmount
                        }
                    },
                    CheatActive: (cheatState.active !== null) || (cheatActive && cheatsEnabled),
                    CheatType: cheatState.active || (cheatActive && cheatsEnabled ? cheatType : null)
                };
            } else if (hasNumberBet) {
                // Only straight bet on a specific number (no additional color/type bet)
                // Send as a simple 'straight' bet so the backend uses the dedicated straight-bet logic.
                requestBody = {
                    Username: username,
                    BetAmount: betAmount,
                    BetType: 'straight',
                    BetValue: {
                        [`bet_${selectedNumber}`]: {
                            type: 'straight',
                            value: selectedNumber.toString(),
                            amount: betAmount
                        }
                    },
                    CheatActive: (cheatState.active !== null) || (cheatActive && cheatsEnabled),
                    CheatType: cheatState.active || (cheatActive && cheatsEnabled ? cheatType : null)
                };
            } else {
                // Simple color/type bet only
                requestBody = {
                    Username: username,
                    BetAmount: betAmount,
                    BetType: betType,
                    CheatActive: (cheatState.active !== null) || (cheatActive && cheatsEnabled),
                    CheatType: cheatState.active || (cheatActive && cheatsEnabled ? cheatType : null)
                };
            }
            
            try {
                const response = await fetch('/api/games/roulette/spin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const result = await response.json();
                
                // Wait for animation to complete
                setTimeout(() => {
                    wheel.classList.remove('spinning');
                    
                    // Display result
                    const winningNumber = result.winningNumber !== undefined ? result.winningNumber : result.winning_number;
                    const color = result.color || (winningNumber === 0 ? 'green' : (redNumbers.includes(winningNumber) ? 'red' : 'black'));
                    const win = result.win || false;
                    const payout = result.payout || 0;
                    
                    document.getElementById('winningNumber').textContent = winningNumber;
                    document.getElementById('winningColor').textContent = color.toUpperCase();
                    document.getElementById('winningColor').className = `text-lg font-bold ${color === 'red' ? 'text-red-500' : color === 'black' ? 'text-gray-300' : 'text-green-500'}`;
                    
                    // Always use server balance - server is the source of truth
                    // Backend handles all game logic including balance calculation
                    let newBalance;
                    if (result.newBalance !== undefined) {
                        newBalance = result.newBalance;
                    } else if (result.balance !== undefined) {
                        newBalance = result.balance;
                    } else {
                        // Fallback: if server doesn't provide balance, log warning
                        console.warn('‚ö†Ô∏è Server did not provide balance, using local calculation as fallback');
                        const currentBalance = parseFloat(localStorage.getItem('vegasBalance') || '1000');
                        newBalance = currentBalance - betAmount + payout;
                    }
                    localStorage.setItem('vegasBalance', String(newBalance));
                    updateBalanceDisplay();
                    
                    // Show result message
                    const resultDiv = document.getElementById('gameResult');
                    const resultText = document.getElementById('resultText');
                    resultDiv.classList.remove('hidden');
                    
                    if (win) {
                        let winMessage = `<div class="text-green-400 text-xl font-bold">üéâ You Win! Payout: $${payout.toFixed(2)}</div>`;
                        if (result.cheatBoosted) {
                            winMessage += `<div class="text-dt-orange text-sm mt-2">‚ö° Cheat Boosted!</div>`;
                        }
                        resultText.innerHTML = winMessage;
                    } else {
                        resultText.innerHTML = `<div class="text-red-400 text-xl">üò¢ No win this time</div>`;
                    }
                    
                    // Re-enable spin button
                    spinBtn.disabled = false;
                    spinBtn.textContent = 'üé° SPIN';
                }, 3000);
                
            } catch (error) {
                console.error('Error spinning roulette:', error);
                wheel.classList.remove('spinning');
                spinBtn.disabled = false;
                spinBtn.textContent = 'üé° SPIN';
                alert('Error: ' + error.message);
            }
        }
        
    </script>
</body>
</html>
