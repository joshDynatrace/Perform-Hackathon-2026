<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynatrace Vegas Casino - Smartscape Lobby</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dt-purple': '#6C2C9C',
                        'dt-blue': '#00A1C9',
                        'dt-cyan': '#00D4FF',
                        'dt-green': '#73BE28',
                        'dt-orange': '#FFA86B',
                        'dt-yellow': '#FFD23F',
                        'dt-dark': '#151515',
                        'dt-darker': '#0A0A0A',
                        'dt-gray': '#2D2D2D',
                        'dt-light-gray': '#4A4A4A'
                    }
                }
            }
        }
    </script>
    
    <!-- External libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- OpenTelemetry Browser Instrumentation -->
    <!-- Note: Browser tracing relies on auto-instrumentation from fetch/XMLHttpRequest -->
    <!-- The trace context will be propagated via HTTP headers automatically -->
    <script src="/js/opentelemetry-browser.js"></script>
    
    <style>
        /* Responsive Layout System */
        .responsive-layout {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }
        
        .responsive-header {
            height: clamp(80px, 10vh, 120px);
            flex-shrink: 0;
            position: relative;
            z-index: 50;
        }
        
        .responsive-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        /* Pulsing dot animation */
        .pulsing-dot {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Status indicator */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
        }

        /* Enhanced Welcome Section Animations */
        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0,0,0);
            }
            40%, 43% {
                transform: translate3d(0,-15px,0);
            }
            70% {
                transform: translate3d(0,-8px,0);
            }
            90% {
                transform: translate3d(0,-2px,0);
            }
        }

        .animate-bounce {
            animation: bounce 2s ease-in-out infinite;
        }

        /* Enhanced hover effects for feature cards */
        .feature-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .feature-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 20px 40px rgba(0, 212, 255, 0.3);
        }

        /* Gradient text animation */
        .gradient-text {
            background-size: 200% 200%;
            animation: gradient-shift 3s ease-in-out infinite;
        }

        @keyframes gradient-shift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Responsive Layout Grid */
        .lobby-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: clamp(2rem, 4vh, 4rem);
            padding: clamp(2rem, 4vh, 4rem);
        }
        
        /* Welcome Section Responsive */
        .welcome-section {
            padding: clamp(2rem, 4vh, 3rem);
            margin-bottom: clamp(2rem, 3vh, 3rem);
            border-radius: clamp(16px, 2vw, 24px);
        }
        
        .welcome-title {
            font-size: clamp(2rem, 4vw, 3.5rem);
            line-height: clamp(2.2rem, 4.5vw, 3.8rem);
            margin-bottom: clamp(1rem, 2vh, 1.5rem);
        }
        
        .welcome-subtitle {
            font-size: clamp(1.1rem, 2.2vw, 1.5rem);
            line-height: clamp(1.4rem, 2.8vw, 1.8rem);
            margin-bottom: clamp(1.5rem, 3vh, 2rem);
        }
        
        .welcome-description {
            font-size: clamp(0.95rem, 1.8vw, 1.1rem);
            line-height: clamp(1.4rem, 2.5vw, 1.6rem);
            margin-bottom: clamp(1.5rem, 3vh, 2rem);
        }
        
        /* Game Nodes Responsive */
        .game-nodes-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: clamp(1.5rem, 3vw, 2.5rem);
            margin-bottom: clamp(2rem, 4vh, 3rem);
            max-width: 100%;
        }
        
        /* Mobile responsive - stack on very small screens */
        @media (max-width: 768px) {
            .game-nodes-grid {
                grid-template-columns: 1fr;
                gap: clamp(1rem, 2vh, 1.5rem);
            }
        }
        
        /* Tablet responsive - 2 columns */
        @media (min-width: 769px) and (max-width: 1024px) {
            .game-nodes-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .game-node {
            position: relative;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.3));
            padding: clamp(1rem, 2vh, 2rem);
            border-radius: clamp(12px, 1.5vw, 20px);
            min-height: clamp(180px, 22vh, 280px);
            width: 100%;
        }
        
        /* Documentation Links Responsive */
        .docs-panel {
            padding: clamp(1rem, 2vh, 1.5rem);
            border-radius: clamp(8px, 1vw, 12px);
            gap: clamp(0.75rem, 1.5vh, 1rem);
        }
        
        .docs-title {
            font-size: clamp(1rem, 1.8vw, 1.2rem);
            margin-bottom: clamp(0.75rem, 1.5vh, 1rem);
        }
        
        .docs-link {
            padding: clamp(0.5rem, 1vh, 0.75rem) clamp(0.75rem, 1.5vh, 1rem);
            border-radius: clamp(4px, 0.5vw, 6px);
            font-size: clamp(0.85rem, 1.5vw, 0.95rem);
            margin-bottom: clamp(0.25rem, 0.5vh, 0.5rem);
        }
        
        /* Smartscape-inspired styles with responsive scaling */
        .smartscape-bg {
            background: 
                radial-gradient(circle at 10% 20%, rgba(108, 44, 156, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 90% 80%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                linear-gradient(135deg, #0A0A0A 0%, #151515 100%);
        }
        
        .game-node::before {
            content: '';
            position: absolute;
            inset: -2px;
            padding: 2px;
            background: linear-gradient(45deg, #00D4FF, #6C2C9C, #73BE28, #FFD23F);
            border-radius: inherit;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: -1;
        }
        
        .game-node:hover::before {
            opacity: 0.8;
        }
        
        .game-node:hover {
            transform: scale(1.1) translateY(-10px);
            filter: drop-shadow(0 20px 40px rgba(0, 212, 255, 0.4));
        }
        
        .connection-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00D4FF, transparent);
            opacity: 0.6;
            animation: pulse-line 2s ease-in-out infinite;
        }
        
        @keyframes pulse-line {
            0%, 100% { opacity: 0.3; transform: scaleX(1); }
            50% { opacity: 0.8; transform: scaleX(1.1); }
        }
        
        .metrics-overlay {
            background: rgba(21, 21, 21, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        
        .pulsing-dot {
            animation: pulse-dot 2s ease-in-out infinite;
        }
        
        @keyframes pulse-dot {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: status-blink 1.5s ease-in-out infinite;
        }
        
        @keyframes status-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        .holographic-text {
            background: linear-gradient(45deg, #00D4FF, #6C2C9C, #00D4FF);
            background-size: 200% 200%;
            animation: holographic 3s ease-in-out infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @keyframes holographic {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        /* Side Panel Styles */
        .side-panel {
            background: 
                radial-gradient(circle at 20% 30%, rgba(108, 44, 156, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(0, 212, 255, 0.1) 0%, transparent 40%),
                linear-gradient(145deg, rgba(21, 21, 21, 0.98), rgba(45, 45, 45, 0.95));
            backdrop-filter: blur(20px);
            box-shadow: 
                2px 0 20px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(108, 44, 156, 0.3),
                inset -1px 0 0 rgba(0, 212, 255, 0.2);
        }
        
        .side-panel-open {
            transform: translateX(0) !important;
        }
        
        .main-content-shifted {
            margin-left: min(320px, 25vw);
        }
        
        .header-shifted {
            margin-left: min(320px, 25vw);
        }
        
        .config-toggle-btn {
            background: 
                radial-gradient(circle at 30% 40%, rgba(108, 44, 156, 0.6) 0%, transparent 70%),
                radial-gradient(circle at 70% 60%, rgba(0, 212, 255, 0.4) 0%, transparent 60%),
                linear-gradient(135deg, rgba(21, 21, 21, 0.9), rgba(45, 45, 45, 0.8));
            border: 1px solid rgba(0, 212, 255, 0.3);
        }
        
        .config-toggle-btn:hover {
            background: 
                radial-gradient(circle at 30% 40%, rgba(108, 44, 156, 0.8) 0%, transparent 70%),
                radial-gradient(circle at 70% 60%, rgba(0, 212, 255, 0.6) 0%, transparent 60%),
                linear-gradient(135deg, rgba(21, 21, 21, 0.95), rgba(45, 45, 45, 0.9));
            border-color: rgba(0, 212, 255, 0.5);
            transform: translateY(-1px);
        }
        
        .config-toggle-btn.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateX(-100px);
        }

        /* Hide only the sidebar metrics overlay and quick actions bottom bar */
        .fixed.top-24.right-6 { display: none !important; }
        .fixed.bottom-6 { display: none !important; }
    </style>
</head>
<body class="responsive-layout smartscape-bg text-white font-sans">
    
    <!-- Header -->
    <header class="responsive-header header bg-dt-dark/90 backdrop-blur-md border-b border-dt-cyan/20 flex-shrink-0">
        <div class="h-full w-full flex items-center justify-between px-4">
            <div class="flex items-center space-x-4 ml-16">
                <div class="flex items-center space-x-4">
                    <div class="w-10 h-10 bg-gradient-to-br from-dt-purple to-dt-cyan rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg sm:text-xl font-bold bg-gradient-to-r from-dt-cyan via-dt-purple to-dt-green bg-clip-text text-transparent leading-relaxed pb-1">
                            üåê Dynatrace Vegas
                        </h1>
                        <p class="text-xs text-dt-light-gray hidden sm:block">Smartscape Lobby</p>
                    </div>
                </div>
            </div>
            
            <!-- User info and balance -->
            <div class="flex items-center space-x-4">
                <div class="bg-dt-dark/60 border border-dt-cyan/20 rounded-lg px-3 py-2">
                    <div class="flex items-center space-x-4 text-sm">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-dt-green rounded-full animate-pulse"></div>
                            <span class="text-dt-cyan">Agent:</span>
                            <span id="agentName" class="font-mono text-white text-xs">Loading...</span>
                            <button onclick="changeUser()" class="bg-dt-purple hover:bg-dt-purple/80 text-white px-2 py-1 rounded text-xs font-semibold transition-colors" title="Change Player">
                                üîÑ
                            </button>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-dt-cyan">Balance:</span>
                            <span id="balanceDisplay" class="font-mono text-dt-yellow font-semibold">$<span id="balance">1000</span></span>
                        </div>
                        <button onclick="addFunds()" class="bg-dt-green hover:bg-dt-green/80 text-white px-3 py-1 rounded text-xs font-semibold transition-colors">
                            Deposit
                        </button>
                        <a href="/dashboard.html" target="_self" class="bg-dt-blue hover:bg-dt-blue/80 text-white px-3 py-1 rounded text-xs font-semibold transition-colors inline-flex items-center gap-1">
                            üìä Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Smartscape Map -->
    <main class="responsive-main main-content">
        <!-- Game Nodes Section - With extra top padding to avoid title bar overlap -->
        <div class="max-w-7xl mx-auto px-clamp(1rem, 3vw, 3rem)">
            <section class="pt-clamp(3rem, 6vh, 4rem) pb-clamp(2rem, 4vh, 3rem)">
                <!-- Game nodes arranged in Smartscape style -->
                <div class="game-nodes-grid relative">
                    
                    <!-- Slots Game Node -->
                    <div class="game-node" onclick="navigateToGame('slots')">
                        <div class="bg-gradient-to-br from-dt-purple/20 to-dt-blue/20 rounded-2xl p-6 border border-dt-cyan/30 backdrop-blur-sm">
                            <div class="text-center">
                                <div class="w-20 h-20 mx-auto bg-gradient-to-br from-dt-purple to-dt-blue rounded-xl flex items-center justify-center mb-4 shadow-lg overflow-hidden">
                                    <img src="/assets/slot-icons/dynatrace.png" alt="Slots" class="w-12 h-12 object-contain" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\'text-3xl\'>üé∞</div>'">
                                </div>
                                <h3 class="text-xl font-bold text-dt-cyan mb-2">üåê Smartscape Slots</h3>
                                <p class="text-dt-light-gray text-sm mb-4">Advanced probability matrices</p>
                                <div class="flex justify-between text-xs text-dt-light-gray">
                                    <span>RTP: 96.5%</span>
                                    <span class="text-dt-green">Online</span>
                                </div>
                                <div class="mt-2 flex justify-center">
                                    <div class="flex space-x-1">
                                        <div class="pulsing-dot w-1 h-1 bg-dt-cyan rounded-full"></div>
                                        <div class="pulsing-dot w-1 h-1 bg-dt-purple rounded-full" style="animation-delay: 0.2s;"></div>
                                        <div class="pulsing-dot w-1 h-1 bg-dt-green rounded-full" style="animation-delay: 0.4s;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Blackjack Game Node -->
                    <div class="game-node" onclick="navigateToGame('blackjack')">
                        <div class="bg-gradient-to-br from-dt-blue/20 to-dt-cyan/20 rounded-2xl p-6 border border-dt-blue/30 backdrop-blur-sm">
                            <div class="text-center">
                                <div class="w-20 h-20 mx-auto bg-gradient-to-br from-dt-blue to-dt-cyan rounded-lg flex items-center justify-center mb-4 shadow-lg overflow-hidden">
                                    <div class="text-3xl">üÉè</div>
                                </div>
                                <h3 class="text-xl font-bold text-dt-blue mb-2">‚ô†Ô∏è Service Blackjack</h3>
                                <p class="text-dt-light-gray text-sm mb-4">AI-enhanced card analysis</p>
                                <div class="flex justify-between text-xs text-dt-light-gray">
                                    <span>Basic Strategy: 99.5%</span>
                                    <span class="text-dt-green">Online</span>
                                </div>
                                <div class="mt-2 flex justify-center">
                                    <div class="flex space-x-1">
                                        <div class="pulsing-dot w-1 h-1 bg-dt-blue rounded-full"></div>
                                        <div class="pulsing-dot w-1 h-1 bg-dt-cyan rounded-full" style="animation-delay: 0.1s;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Roulette Game Node -->
                    <div class="game-node" onclick="navigateToGame('roulette')">
                        <div class="bg-gradient-to-br from-dt-green/20 to-dt-yellow/20 rounded-2xl p-6 border border-dt-green/30 backdrop-blur-sm">
                            <div class="text-center">
                                <div class="w-20 h-20 mx-auto bg-gradient-to-br from-dt-green to-dt-yellow rounded-lg flex items-center justify-center mb-4 shadow-lg overflow-hidden">
                                    <div class="text-3xl">üé°</div>
                                </div>
                                <h3 class="text-xl font-bold text-dt-green mb-2">üé° European Roulette</h3>
                                <p class="text-dt-light-gray text-sm mb-4">37-number wheel with live betting</p>
                                <div class="flex justify-between text-xs text-dt-light-gray">
                                    <span>RTP: 97.3%</span>
                                    <span class="text-dt-green">Online</span>
                                </div>
                                <div class="mt-2 flex justify-center">
                                    <div class="flex space-x-1">
                                        <div class="pulsing-dot w-1 h-1 bg-dt-green rounded-full"></div>
                                        <div class="pulsing-dot w-1 h-1 bg-dt-yellow rounded-full" style="animation-delay: 0.2s;"></div>
                                        <div class="pulsing-dot w-1 h-1 bg-red-500 rounded-full" style="animation-delay: 0.4s;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dice Game Node -->
                    <div class="game-node" onclick="navigateToGame('dice')">
                        <div class="bg-gradient-to-br from-dt-orange/20 to-dt-yellow/20 rounded-2xl p-6 border border-dt-orange/30 backdrop-blur-sm">
                            <div class="text-center">
                                <div class="w-20 h-20 mx-auto bg-gradient-to-br from-dt-orange to-dt-yellow rounded-lg flex items-center justify-center mb-4 shadow-lg overflow-hidden">
                                    <div class="text-3xl">üé≤</div>
                                </div>
                                <h3 class="text-xl font-bold text-dt-orange mb-2">üé≤ Process Dice</h3>
                                <p class="text-dt-light-gray text-sm mb-4">Probability prediction engine</p>
                                <div class="flex justify-between text-xs text-dt-light-gray">
                                    <span>Max Payout: 30:1</span>
                                    <span class="text-dt-green">Online</span>
                                </div>
                                <div class="mt-2 flex justify-center">
                                    <div class="flex space-x-1">
                                        <div class="pulsing-dot w-1 h-1 bg-dt-orange rounded-full"></div>
                                        <div class="pulsing-dot w-1 h-1 bg-dt-yellow rounded-full" style="animation-delay: 0.4s;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </section>
        </div>
            
        <!-- Welcome Section - Full Width Below game nodes -->
        <section class="welcome-section py-clamp(3rem, 5vh, 4rem) px-clamp(1rem, 3vw, 3rem)">
            <div class="relative bg-gradient-to-br from-dt-dark/90 via-dt-purple/30 to-dt-cyan/20 border-2 border-dt-cyan/40 shadow-2xl rounded-2xl backdrop-blur-sm overflow-hidden">
                <!-- Animated background elements -->
                <div class="absolute inset-0 opacity-20">
                    <div class="absolute top-4 right-4 w-32 h-32 bg-gradient-to-br from-dt-purple/50 to-dt-cyan/50 rounded-full blur-xl animate-pulse"></div>
                    <div class="absolute bottom-4 left-4 w-24 h-24 bg-gradient-to-br from-dt-green/50 to-dt-yellow/50 rounded-full blur-lg animate-pulse" style="animation-delay: 1s;"></div>
                </div>
                
                <div class="relative p-clamp(2rem, 4vh, 3rem)">
                    <div class="text-center mb-clamp(2rem, 3vh, 2.5rem)">
                        <div class="flex items-center justify-center mb-6">
                            <div class="text-clamp(3rem, 6vw, 4rem) mr-4 animate-bounce" style="animation-delay: 0.5s;">üé∞</div>
                            <h2 class="welcome-title text-clamp(2rem, 4vw, 3rem) font-black bg-gradient-to-r from-dt-cyan via-dt-purple to-dt-green bg-clip-text text-transparent animate-pulse mb-2 pb-1">
                                Welcome to Dynatrace Vegas!
                                
                            </h2>
                            <div class="text-clamp(3rem, 6vw, 4rem) ml-4 animate-bounce" style="animation-delay: 1s;">‚ú®</div>
                        </div>
                        <div class="max-w-4xl mx-auto">
                            <p class="welcome-subtitle text-clamp(1.1rem, 2.5vw, 1.4rem) text-dt-light-gray leading-relaxed mb-4">
                                üéâ <strong class="text-dt-cyan">Ready to explore?</strong> This interactive casino experience brings together the power of Dynatrace observability with the excitement of gaming! 
                            </p>
                            <div class="flex justify-center space-x-2 mb-6">
                                <div class="pulsing-dot w-3 h-3 bg-dt-cyan rounded-full"></div>
                                <div class="pulsing-dot w-3 h-3 bg-dt-purple rounded-full" style="animation-delay: 0.3s;"></div>
                                <div class="pulsing-dot w-3 h-3 bg-dt-green rounded-full" style="animation-delay: 0.6s;"></div>
                                <div class="pulsing-dot w-3 h-3 bg-dt-yellow rounded-full" style="animation-delay: 0.9s;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-8 p-6 bg-gradient-to-r from-dt-purple/20 via-dt-cyan/20 to-dt-green/20 border-2 border-dt-cyan/40 rounded-2xl text-center relative overflow-hidden">
                        <!-- Animated background -->
                        <div class="absolute inset-0 bg-gradient-to-r from-dt-purple/10 via-dt-cyan/10 to-dt-green/10 animate-pulse"></div>
                        
                        <div class="relative">
                            <div class="flex items-center justify-center mb-4">
                                <div class="text-3xl mr-3 animate-bounce">üöÄ</div>
                                <h3 class="text-2xl font-bold bg-gradient-to-r from-dt-cyan to-dt-green bg-clip-text text-transparent">Ready to Start Your Journey?</h3>
                                <div class="text-3xl ml-3 animate-bounce" style="animation-delay: 0.5s;">üéÆ</div>
                            </div>
                                                    
                        </div>
                    </div>
                </div>
        </section>
        
        <!-- Live Metrics Panel -->
        <div class="max-w-7xl mx-auto px-clamp(1rem, 3vw, 3rem) py-clamp(2rem, 4vh, 3rem)">
          
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </main>

    <script>

        function navigateToGame(gameType) {
            // Create span for game navigation
            const username = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous';
            const traceId = 'nav-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            // Send navigation event to backend for tracing
            fetch('/api/user/navigate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    Username: username,
                    GameType: gameType,
                    TraceId: traceId,
                    Action: 'navigate_to_game'
                })
            }).catch(err => console.warn('Navigation trace failed:', err));
            
            // Show loading animation
            const gameNode = (typeof event !== 'undefined' && event && event.currentTarget) || null;
            gsap.to(gameNode, {
                duration: 0.3,
                scale: 0.9,
                opacity: 0.8,
                yoyo: true,
                repeat: 1,
                ease: "power2.inOut",
                onComplete: () => {
                    // Navigate to game page
                    const gameUrls = {
                        'slots': 'slots.html',
                        'roulette': 'roulette.html',
                        'dice': 'dice.html',
                        'blackjack': 'blackjack.html'
                    };
                    window.location.href = gameUrls[gameType];
                }
            });
        }
        
        // Quick spin function
        async function quickSpin() {
            // Trigger a quick slots spin and show result in popup
            const username = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous';
            
            // Ensure required fields are populated
            const requiredFields = {
                'vegas.customerName': username,
                'vegas.email': 'user@example.com',
                'vegas.companyName': 'Dynatrace',
                'vegas.persona': 'Customer',
                'vegas.booth': 'Business Analytics',
                'vegas.optIn': 'true'
            };
            
            for (const [key, defaultValue] of Object.entries(requiredFields)) {
                if (!localStorage.getItem(key)) {
                    localStorage.setItem(key, defaultValue);
                }
            }
            
            try {
                const bet = 5;
                const corrId = `sim_${Date.now()}_${Math.floor(Math.random()*1e9)}`;
                const resp = await fetch('/api/slots/spin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        Game: 'Vegas Slots Machine',
                        BetAmount: bet,
                        Username: username,
                        CustomerName: localStorage.getItem('vegas.customerName') || username || 'Anonymous',
                        Email: localStorage.getItem('vegas.email') || '',
                        CompanyName: localStorage.getItem('vegas.companyName') || '',
                        Persona: localStorage.getItem('vegas.persona') || '',
                        Booth: localStorage.getItem('vegas.booth') || '',
                        OptIn: localStorage.getItem('vegas.optIn') === 'true',
                        WinFlag: null,
                        WinningAmount: 0,
                        LossAmount: 0,
                        Balance: parseInt(localStorage.getItem('vegasBalance') || '0'),
                        Timestamp: new Date().toISOString(),
                        Action: 'Spin',
                        Device: 'Browser-UI',
                        CorrelationId: corrId,
                        ResultIcons: [],
                        Status: 'Started',
                        ErrorType: null,
                        ErrorMessage: null,
                        StatusCode: 0
                    })
                });
                const data = await resp.json();
                showQuickSpinResult(data);
                // Prefer server-authoritative balance
                if (typeof data.newBalance === 'number') {
                    localStorage.setItem('vegasBalance', String(data.newBalance));
                    updateBalanceDisplay();
                } else {
                    // Fallback: fetch current balance from server
                    const u = await fetch(`/api/user/balance?username=${encodeURIComponent(username)}`).then(r => r.json());
                    if (typeof u.balance === 'number') {
                        localStorage.setItem('vegasBalance', String(u.balance));
                        updateBalanceDisplay();
                    }
                }
            } catch (error) {
                console.error('Quick spin error:', error);
            }
        }
        
        function showQuickSpinResult(result) {
            // Create and show result popup
            const popup = document.createElement('div');
            popup.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center';
            popup.innerHTML = `
                <div class="bg-dt-dark border border-dt-cyan/30 rounded-xl p-6 mx-4 max-w-sm w-full">
                    <h3 class="text-xl font-bold text-dt-cyan text-center mb-4">Quick Spin Result</h3>
                    <div class="flex justify-center space-x-2 mb-4">
                        ${result.result.map(icon => `<div class="w-12 h-12 bg-dt-purple rounded-lg flex items-center justify-center text-2xl">${icon[0].toUpperCase()}</div>`).join('')}
                    </div>
                    <div class="text-center">
                        <p class="text-lg ${result.win ? 'text-dt-green' : 'text-dt-light-gray'} mb-2">
                            ${result.win ? `üéâ Win: $${result.winAmount}` : 'üò¢ No win this time'}
                        </p>
                        <p class="text-sm text-dt-light-gray">Bet: $${result.betAmount}</p>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="w-full mt-4 bg-dt-purple hover:bg-dt-purple/80 text-white py-2 rounded-lg font-semibold transition-colors">
                        Close
                    </button>
                </div>
            `;
            document.body.appendChild(popup);
            
            // Auto-close after 5 seconds
            setTimeout(() => {
                if (popup.parentElement) {
                    popup.remove();
                }
            }, 5000);
        }
        
        // Balance management
        async function addFunds() {
            const username = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous';
            const traceId = 'deposit-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            try {
                const resp = await fetch('/api/user/topup', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Trace-Id': traceId,
                        'X-User-Action': 'deposit'
                    },
                    body: JSON.stringify({ 
                        Username: username, 
                        Amount: 500,
                        TraceId: traceId
                    })
                });
                const data = await resp.json();
                if (typeof data.balance === 'number') {
                    localStorage.setItem('vegasBalance', String(data.balance));
                    updateBalanceDisplay();
                    showNotification('üí∞ $500 added to your balance!', 'success');
                } else {
                    showNotification('Top-up failed to persist.', 'error');
                }
            } catch (e) {
                showNotification('Top-up request failed.', 'error');
            }
        }
        
        function updateBalance(change) {
            const currentBalance = parseInt(localStorage.getItem('vegasBalance') || '0');
            const newBalance = Math.max(0, currentBalance + change);
            localStorage.setItem('vegasBalance', newBalance);
            updateBalanceDisplay();
        }
        
        function updateBalanceDisplay() {
            const balance = localStorage.getItem('vegasBalance') || '1000';
            const balanceElement = document.getElementById('balance');
            if (balanceElement) {
                balanceElement.textContent = balance;
            }
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-6 right-6 z-50 p-4 rounded-lg shadow-lg ${
                type === 'success' ? 'bg-dt-green text-white' : 
                type === 'error' ? 'bg-red-500 text-white' : 
                'bg-dt-blue text-white'
            }`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Animate in
            gsap.from(notification, {
                duration: 0.3,
                x: 100,
                opacity: 0,
                ease: "back.out(1.7)"
            });
            
            // Auto remove
            setTimeout(() => {
                gsap.to(notification, {
                    duration: 0.3,
                    x: 100,
                    opacity: 0,
                    ease: "back.in(1.7)",
                    onComplete: () => notification.remove()
                });
            }, 3000);
        }
        
        
        function showProfile() {
            // Show profile modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-dt-dark border border-dt-cyan/30 rounded-xl p-6 mx-4 max-w-md w-full">
                    <h3 class="text-xl font-bold text-dt-cyan text-center mb-4">Agent Profile</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-dt-light-gray text-sm">Agent Name:</label>
                            <p class="text-white font-mono">${localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser') || 'Anonymous'}</p>
                        </div>
                        <div>
                            <label class="text-dt-light-gray text-sm">Security Level:</label>
                            <p class="text-dt-cyan font-mono">${localStorage.getItem('securityLevel') || 'Standard'}</p>
                        </div>
                        <div>
                            <label class="text-dt-light-gray text-sm">Current Balance:</label>
                            <p class="text-dt-yellow font-mono">$${localStorage.getItem('vegasBalance') || '0'}</p>
                        </div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="w-full mt-6 bg-dt-purple hover:bg-dt-purple/80 text-white py-2 rounded-lg font-semibold transition-colors">
                        Close Profile
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Socket.IO removed - using HTTP/gRPC architecture instead
        // Real-time metrics can be fetched via HTTP polling if needed
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user is logged in
            const username = localStorage.getItem('vegas.username') || localStorage.getItem('vegasUser');
            const email = localStorage.getItem('vegas.email');
            const profileType = localStorage.getItem('vegas.profileType');
            
            // If no username or username is Anonymous/Agent, redirect to login
            if (!username || username === 'Anonymous' || username === 'Agent') {
                console.log('[Lobby] User not logged in, redirecting to login');
                window.location.href = '/login.html';
                return;
            }
            
            // Track lobby entry
            const traceId = 'lobby-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            // Send lobby entry event to backend for tracing
            fetch('/api/user/lobby-entry', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-Trace-Id': traceId,
                    'X-User-Action': 'lobby_entry'
                },
                body: JSON.stringify({
                    Username: username,
                    TraceId: traceId,
                    Action: 'enter_lobby',
                    Page: 'lobby.html'
                })
            }).catch(err => console.warn('Lobby entry trace failed:', err));
            
            // Set user info
            console.log('Setting agent name to:', username);
            const agentNameElement = document.getElementById('agentName');
            if (agentNameElement) {
                // Display username with profile type if available
                const profileType = localStorage.getItem('vegas.profileType');
                const email = localStorage.getItem('vegas.email');
                let displayName = username;
                if (profileType) {
                    displayName += ` (${profileType})`;
                }
                agentNameElement.textContent = displayName;
                agentNameElement.title = email ? `Email: ${email}` : username;
                console.log('Agent name element updated:', agentNameElement.textContent);
            } else {
                console.log('Agent name element not found!');
            }
            // Sync balance from server for authoritative state
            try {
                const resp = await fetch('/api/user/init', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'X-Trace-Id': traceId
                    },
                    body: JSON.stringify({ Username: username })
                });
                const data = await resp.json();
                if (data && typeof data.balance === 'number') {
                    localStorage.setItem('vegasBalance', String(data.balance));
                }
            } catch (e) { /* ignore and show last known */ }
            updateBalanceDisplay();
            
            // Animate page entrance - simplified and guarded to avoid hiding elements
            setTimeout(() => {
                try {
                    gsap.from('.game-node', {
                        duration: 0.8,
                        y: 30,
                        opacity: 0,
                        stagger: 0.1,
                        ease: "back.out(1.7)",
                        delay: 0.1,
                        onComplete: ensureGameNodesVisible
                    });
                } catch (e) {
                    // If animation library hiccups, ensure all tiles are visible
                    ensureGameNodesVisible();
                }
                
                // Only animate metrics overlay if it exists
                const metricsOverlay = document.querySelector('.metrics-overlay');
                if (metricsOverlay) {
                    gsap.from('.metrics-overlay', {
                        duration: 0.6,
                        x: 30,
                        opacity: 0,
                        ease: "power3.out",
                        delay: 0.3
                    });
                }
            }, 100);

            // Extra safety: force visibility shortly after initial animations
            setTimeout(ensureGameNodesVisible, 1200);
        });

        // Defensive helper to guarantee all tiles are visible (avoids "only first tile visible" issue)
        function ensureGameNodesVisible() {
            document.querySelectorAll('.game-node').forEach(node => {
                node.style.opacity = '1';
                node.style.visibility = 'visible';
                node.style.transform = 'none';
                // Remove gsap inline styles that could linger
                if (node.style.willChange) node.style.willChange = '';
            });
        }

        // Real-time metrics updates removed - Socket.IO no longer used
        // Metrics can be updated via HTTP polling if needed
        
        // Quick spin function for lobby
        function quickSpin() {
            // Navigate to slots game for a quick spin
            navigateToGame('slots');
        }
        
        // Change user/player identity - redirects to login page
        function changeUser() {
            // Clear all user data and redirect to login
            localStorage.removeItem('vegas.username');
            localStorage.removeItem('vegasUser');
            localStorage.removeItem('vegas.email');
            localStorage.removeItem('vegas.profileType');
            localStorage.removeItem('vegasBalance');
            
            // Redirect to login page
            window.location.href = '/login.html';
        }
    </script>
</body>
</html>