{{- if .Values.playwright.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "vegas-casino.fullname" . }}-playwright
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "vegas-casino.labels" . | nindent 4 }}
    app.kubernetes.io/component: playwright
spec:
  replicas: {{ .Values.playwright.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/name: {{ include "vegas-casino.name" . }}
      app.kubernetes.io/instance: {{ .Release.Name }}
      app.kubernetes.io/component: playwright
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "vegas-casino.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: playwright
      annotations:
        # Kyverno policy exception for Playwright (requires SYS_ADMIN for browser sandboxing)
        policies.kyverno.io/validation.disallow-capabilities: "skip"
        dt.owner: '{{ .Values.global.teamIdentifier }}'
    spec:
      # Playwright needs some privileges to run browsers
      securityContext:
        runAsNonRoot: false
        runAsUser: 0
      containers:
      - name: playwright
        image: "{{ .Values.global.imageRegistry }}-playwright:{{ .Values.global.imageTag }}"
        imagePullPolicy: {{ .Values.global.imagePullPolicy }}
        securityContext:
          allowPrivilegeEscalation: true
          capabilities:
            add:
              - SYS_ADMIN
          runAsNonRoot: false
          runAsUser: 0
        env:
        - name: CASINO_URL
          {{- if .Values.playwright.casinoUrl }}
          value: {{ .Values.playwright.casinoUrl | quote }}
          {{- else }}
          value: "http://{{ include "vegas-casino.fullname" . }}-frontend:{{ .Values.frontend.service.port }}"
          {{- end }}
        - name: USER_NAME
          value: {{ .Values.playwright.userName | quote }}
        - name: USER_EMAIL
          value: {{ .Values.playwright.userEmail | quote }}
        - name: USER_COMPANY
          value: {{ .Values.playwright.userCompany | quote }}
        - name: DELAY_BETWEEN_ACTIONS
          value: {{ .Values.playwright.delayBetweenActions | quote }}
        - name: DELAY_BETWEEN_GAMES
          value: {{ .Values.playwright.delayBetweenGames | quote }}
        - name: RUN_CONTINUOUSLY
          value: {{ .Values.playwright.runContinuously | quote }}
        - name: ITERATIONS
          value: {{ .Values.playwright.iterations | quote }}
        {{- with .Values.playwright.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}

