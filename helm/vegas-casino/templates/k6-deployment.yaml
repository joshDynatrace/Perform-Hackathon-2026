{{- if .Values.k6.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "vegas-casino.fullname" . }}-k6-{{ .Release.Revision }}
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "vegas-casino.labels" . | nindent 4 }}
    app.kubernetes.io/component: k6
  # Note: k6 is NOT a Helm hook because it runs for a long duration (35m)
  # and would timeout Helm's hook wait. It runs as a regular Job instead.
  # annotations:
  #   "helm.sh/hook": post-install,post-upgrade
  #   "helm.sh/hook-weight": "15"
  #   "helm.sh/hook-delete-policy": before-hook-creation
spec:
  backoffLimit: {{ .Values.k6.backoffLimit | default 3 }}  # Allow retries if services aren't ready yet
  completions: {{ .Values.k6.completions | default 1 }}
  parallelism: {{ .Values.k6.parallelism | default 1 }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: {{ include "vegas-casino.name" . }}
        app.kubernetes.io/instance: {{ .Release.Name }}
        app.kubernetes.io/component: k6
      annotations:
        dt.owner: '{{ .Values.global.teamIdentifier }}'
    spec:
      {{- if .Values.k6.restartPolicy }}
      restartPolicy: {{ .Values.k6.restartPolicy }}
      {{- else }}
      restartPolicy: Never
      {{- end }}
      initContainers:
      - name: wait-for-frontend
        image: curlimages/curl:latest
        command:
        - sh
        - -c
        - |
          echo "Waiting for frontend service to be ready..."
          FRONTEND_URL="http://{{ include "vegas-casino.fullname" . }}-frontend:{{ .Values.frontend.service.port }}"
          echo "Checking frontend at: $FRONTEND_URL"
          for i in $(seq 1 60); do
            if curl -f -s --max-time 5 "$FRONTEND_URL/health" > /dev/null 2>&1; then
              echo "✅ Frontend service is ready!"
              exit 0
            fi
            if [ $((i % 6)) -eq 0 ]; then
              echo "⏳ Attempt $i/60: Frontend not ready yet, waiting..."
            fi
            sleep 5
          done
          echo "❌ Frontend service did not become ready in time (5 minutes)"
          echo "This is non-fatal - k6 will still attempt to run"
          exit 0  # Don't fail the job, let k6 try anyway
      containers:
      - name: k6
        image: "{{ .Values.global.imageRegistry }}-k6:{{ .Values.global.imageTag }}"
        imagePullPolicy: {{ .Values.global.imagePullPolicy }}
        env:
        - name: CASINO_URL
          {{- if .Values.k6.casinoUrl }}
          value: {{ .Values.k6.casinoUrl | quote }}
          {{- else }}
          value: "http://{{ include "vegas-casino.fullname" . }}-frontend:{{ .Values.frontend.service.port }}"
          {{- end }}
        - name: VUS
          value: {{ .Values.k6.vus | quote }}
        - name: DURATION
          value: {{ .Values.k6.duration | quote }}
        - name: RAMP_UP
          value: {{ .Values.k6.rampUp | quote }}
        {{- with .Values.k6.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
{{- end }}

